
# 在scan_executor.py的_prepare_domains_for_analysis方法中添加更强的路径检查
def robust_screenshot_check(screenshot_path: str, task_id: str, domain: str) -> bool:
    """强化的截图文件检查"""
    if not screenshot_path:
        self.logger.debug(f"域名 {domain} 没有截图路径")
        return False
    
    # 尝试多种路径检查方式
    check_paths = []
    
    # 1. 原始路径
    check_paths.append(Path(screenshot_path))
    
    # 2. 绝对路径
    if not Path(screenshot_path).is_absolute():
        check_paths.append(Path.cwd() / screenshot_path)
    
    # 3. 截图目录下的文件名
    filename = Path(screenshot_path).name
    check_paths.append(Path("screenshots") / task_id / filename)
    
    # 4. 配置目录下的路径
    from app.core.config import settings
    if hasattr(settings, 'SCREENSHOT_PATH'):
        check_paths.append(Path(settings.SCREENSHOT_PATH) / task_id / filename)
    
    for path in check_paths:
        if path.exists():
            self.logger.debug(f"域名 {domain} 截图文件找到: {path}")
            return True
        else:
            self.logger.debug(f"域名 {domain} 截图路径不存在: {path}")
    
    self.logger.warning(f"域名 {domain} 所有路径检查都失败: {screenshot_path}")
    return False
