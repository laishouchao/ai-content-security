# Celery Worker ç¼“å­˜æ¸…ç†è§£å†³æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

åœ¨Celery Workerå¯åŠ¨æ—¶å‡ºç°çš„å¤–é”®çº¦æŸé”™è¯¯ï¼Œæ ¹æœ¬åŸå› æ˜¯ï¼š

1. **æ•°æ®ä¸ä¸€è‡´é—®é¢˜**: Redisä¸­å­˜åœ¨æ—§çš„Celeryä»»åŠ¡ä¿¡æ¯ï¼Œä½†æ•°æ®åº“ä¸­å¯¹åº”çš„ `scan_tasks` è®°å½•å·²è¢«åˆ é™¤
2. **ä»»åŠ¡æ‰§è¡Œå¤±è´¥**: å½“Celery Workerå°è¯•æ‰§è¡Œè¿™äº›"å­¤ç«‹"ä»»åŠ¡æ—¶ï¼Œä¼šå°è¯•å‘æ•°æ®åº“æ’å…¥å­è¡¨è®°å½•ï¼Œä½†å¤–é”®çº¦æŸå¤±è´¥
3. **ç¼“å­˜æ¸…ç†ç¼ºå¤±**: ç³»ç»Ÿç¼ºä¹æœ‰æ•ˆçš„ç¼“å­˜æ¸…ç†æœºåˆ¶æ¥å¤„ç†è¿™ç§æ•°æ®ä¸ä¸€è‡´

## è§£å†³æ–¹æ¡ˆ

### 1. ç¼“å­˜ç®¡ç†å™¨ (`app/core/cache_manager.py`)

**åŠŸèƒ½ç‰¹æ€§:**
- è‡ªåŠ¨æ£€æµ‹Redisä¸­çš„å­¤ç«‹Celeryä»»åŠ¡
- æ¸…ç†è¿‡æœŸçš„ä»»åŠ¡ç»“æœ
- å¤„ç†æ•°æ®åº“å­¤ç«‹è®°å½•
- æä¾›å®Œæ•´çš„ç¼“å­˜æ¸…ç†æµç¨‹

**æ ¸å¿ƒæ–¹æ³•:**
```python
# æ£€æµ‹å­¤ç«‹ä»»åŠ¡
async def get_orphaned_celery_tasks() -> List[Dict[str, Any]]

# æ¸…ç†å­¤ç«‹ä»»åŠ¡
async def cleanup_orphaned_celery_tasks() -> int

# å®Œæ•´æ¸…ç†
async def perform_full_cleanup() -> Dict[str, Any]
```

### 2. ç¼“å­˜ç®¡ç†API (`app/api/v1/cache.py`)

**æ¥å£ç«¯ç‚¹:**
- `GET /api/v1/cache/status` - è·å–ç¼“å­˜çŠ¶æ€
- `GET /api/v1/cache/celery-tasks` - æŸ¥çœ‹Celeryä»»åŠ¡ä¿¡æ¯
- `POST /api/v1/cache/cleanup/orphaned-tasks` - æ¸…ç†å­¤ç«‹ä»»åŠ¡
- `POST /api/v1/cache/cleanup/full` - æ‰§è¡Œå®Œæ•´æ¸…ç†

### 3. å‘½ä»¤è¡Œå·¥å…· (`cache_manager_cli.py`)

**ä½¿ç”¨æ–¹æ³•:**
```bash
# æŸ¥çœ‹çŠ¶æ€
python cache_manager_cli.py status

# æŸ¥çœ‹å­¤ç«‹ä»»åŠ¡
python cache_manager_cli.py tasks --orphaned

# æ¸…ç†å­¤ç«‹ä»»åŠ¡
python cache_manager_cli.py cleanup-orphaned

# å®Œæ•´æ¸…ç†
python cache_manager_cli.py full-cleanup
```

### 4. Workerè‡ªåŠ¨æ¸…ç†

åœ¨Celery Workerå¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œç¼“å­˜æ¸…ç†ï¼š

```python
@worker_init.connect
def worker_init_handler(sender=None, **kwargs):
    # åˆå§‹åŒ–ç¼“å­˜ç®¡ç†å™¨å¹¶æ¸…ç†å­¤ç«‹ä»»åŠ¡
    loop.run_until_complete(cache_manager.cleanup_orphaned_celery_tasks())
```

### 5. ä»»åŠ¡æ‰§è¡Œå‰æ£€æŸ¥

åœ¨æ‰«æä»»åŠ¡æ‰§è¡Œå‰æ£€æŸ¥æ•°æ®åº“ä¸€è‡´æ€§ï¼š

```python
@celery_app.task(bind=True, name="scan_domain_task")
def scan_domain_task(self, task_id: str, user_id: str, target_domain: str, config: Dict[str, Any]):
    # æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åœ¨æ•°æ®åº“ä¸­å­˜åœ¨
    task_exists = loop.run_until_complete(_check_task_exists(task_id))
    if not task_exists:
        # æ¸…ç†Redisä¸­çš„å­¤ç«‹ä»»åŠ¡ä¿¡æ¯
        # æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢ä»»åŠ¡æ‰§è¡Œ
```

## ä½¿ç”¨æŒ‡å—

### ç«‹å³è§£å†³å½“å‰é—®é¢˜

1. **æ‰‹åŠ¨æ¸…ç†å­¤ç«‹ä»»åŠ¡**:
```bash
python cache_manager_cli.py cleanup-orphaned
```

2. **æˆ–é€šè¿‡APIæ¸…ç†**:
```bash
curl -X POST "http://localhost:8000/api/v1/cache/cleanup/orphaned-tasks" \
     -H "Authorization: Bearer YOUR_TOKEN"
```

### é¢„é˜²æªæ–½

1. **å®šæœŸæ¸…ç†**: å»ºè®®æ¯å¤©æ‰§è¡Œä¸€æ¬¡å®Œæ•´æ¸…ç†
2. **ç›‘æ§å‘Šè­¦**: é€šè¿‡APIç›‘æ§å­¤ç«‹ä»»åŠ¡æ•°é‡
3. **Workeré‡å¯**: é‡å¯Celery Workeræ—¶ä¼šè‡ªåŠ¨æ¸…ç†

### ç›‘æ§å’Œè¯Šæ–­

**æŸ¥çœ‹ç¼“å­˜çŠ¶æ€:**
```bash
python cache_manager_cli.py status
```

**è¾“å‡ºç¤ºä¾‹:**
```
ğŸ“Š ç¼“å­˜çŠ¶æ€æŠ¥å‘Š (2025-08-27T10:56:40.000Z)
==================================================
Redisè¿æ¥: âœ… å·²è¿æ¥
  - å†…å­˜ä½¿ç”¨: 2.5MB
  - å®¢æˆ·ç«¯è¿æ¥: 3

ğŸ“‹ ä»»åŠ¡ç»Ÿè®¡:
  - Redisä¸­çš„Celeryä»»åŠ¡: 5
  - å­¤ç«‹ä»»åŠ¡: 2
  - æ•°æ®åº“ä¸­çš„ä»»åŠ¡: 10

âš ï¸  å‘ç° 2 ä¸ªå­¤ç«‹ä»»åŠ¡ï¼Œå»ºè®®æ¸…ç†
```

## æŠ€æœ¯å®ç°

### å­¤ç«‹ä»»åŠ¡æ£€æµ‹é€»è¾‘

1. ä»Redisè·å–æ‰€æœ‰ `celery-task-meta-*` é”®
2. æå–ä»»åŠ¡IDåˆ—è¡¨
3. æŸ¥è¯¢æ•°æ®åº“ä¸­å¯¹åº”çš„ `scan_tasks` è®°å½•
4. è¯†åˆ«Redisä¸­å­˜åœ¨ä½†æ•°æ®åº“ä¸­ä¸å­˜åœ¨çš„ä»»åŠ¡

### æ¸…ç†ç­–ç•¥

1. **å®‰å…¨æ¸…ç†**: åªæ¸…ç†ç¡®è®¤å­¤ç«‹çš„ä»»åŠ¡
2. **æ—¥å¿—è®°å½•**: è¯¦ç»†è®°å½•æ¸…ç†è¿‡ç¨‹
3. **é”™è¯¯å¤„ç†**: æ¸…ç†å¤±è´¥ä¸å½±å“ç³»ç»Ÿè¿è¡Œ
4. **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡æ¸…ç†æé«˜æ•ˆç‡

### æ•°æ®åº“äº‹åŠ¡

æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š

```python
async with AsyncSessionLocal() as db:
    try:
        # æ‰§è¡Œæ¸…ç†æ“ä½œ
        await db.commit()
    except Exception as e:
        await db.rollback()
        raise e
```

## é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡

- `REDIS_URL`: Redisè¿æ¥URL
- `DATABASE_URL`: æ•°æ®åº“è¿æ¥URL

### æ¸…ç†å‚æ•°

- `max_age_hours`: ä»»åŠ¡ç»“æœæœ€å¤§ä¿ç•™æ—¶é—´ï¼ˆé»˜è®¤24å°æ—¶ï¼‰
- `cleanup_on_startup`: Workerå¯åŠ¨æ—¶æ˜¯å¦è‡ªåŠ¨æ¸…ç†ï¼ˆé»˜è®¤Trueï¼‰

## æ€§èƒ½è€ƒè™‘

1. **å¼‚æ­¥æ“ä½œ**: æ‰€æœ‰æ¸…ç†æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
2. **æ‰¹é‡å¤„ç†**: æ”¯æŒæ‰¹é‡åˆ é™¤Redisé”®
3. **è¿æ¥å¤ç”¨**: Redisè¿æ¥æ± å¤ç”¨ï¼Œå‡å°‘è¿æ¥å¼€é”€
4. **å†…å­˜ä¼˜åŒ–**: åˆ†æ‰¹å¤„ç†å¤§é‡æ•°æ®ï¼Œé¿å…å†…å­˜æº¢å‡º

## å®‰å…¨æ€§

1. **æƒé™æ§åˆ¶**: APIæ¥å£éœ€è¦ç”¨æˆ·è®¤è¯
2. **æ“ä½œç¡®è®¤**: å±é™©æ“ä½œï¼ˆå¦‚æ¸…ç©ºé˜Ÿåˆ—ï¼‰éœ€è¦ç¡®è®¤
3. **æ—¥å¿—å®¡è®¡**: æ‰€æœ‰æ¸…ç†æ“ä½œéƒ½æœ‰è¯¦ç»†æ—¥å¿—
4. **é”™è¯¯æ¢å¤**: æ¸…ç†å¤±è´¥ä¸ä¼šç ´åç°æœ‰æ•°æ®

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Redisè¿æ¥å¤±è´¥**:
   - æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€
   - éªŒè¯è¿æ¥URLå’Œå¯†ç 

2. **æƒé™ä¸è¶³**:
   - ç¡®è®¤ç”¨æˆ·æœ‰ç®¡ç†å‘˜æƒé™
   - æ£€æŸ¥APIè®¤è¯token

3. **æ¸…ç†å¤±è´¥**:
   - æŸ¥çœ‹æ—¥å¿—äº†è§£å…·ä½“é”™è¯¯
   - æ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€

### æ—¥å¿—ä½ç½®

- åº”ç”¨æ—¥å¿—: `logs/app.log`
- Celeryæ—¥å¿—: Workeræ§åˆ¶å°è¾“å‡º
- æ¸…ç†æ—¥å¿—: åŒ…å«åœ¨åº”ç”¨æ—¥å¿—ä¸­

## ç‰ˆæœ¬å…¼å®¹æ€§

- Python 3.8+
- FastAPI 0.68+
- Celery 5.3+
- Redis 5.0+
- PostgreSQL 12+

## æ›´æ–°è®°å½•

- **v1.0.0**: åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€ç¼“å­˜æ¸…ç†åŠŸèƒ½
- **v1.1.0**: æ·»åŠ å‘½ä»¤è¡Œå·¥å…·å’ŒAPIæ¥å£
- **v1.2.0**: æ·»åŠ Workerè‡ªåŠ¨æ¸…ç†å’Œä»»åŠ¡æ£€æŸ¥